name: Manual contribution creator

on:
  workflow_dispatch:
    inputs:
      parent_repo:
        description: 'Ð Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ð¹ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ (owner/repo)'
        required: true
        default: 'huynhhain/aurora-switch'
        type: string
      commit_type:
        description: 'Ð¢Ð¸Ð¿ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°'
        required: true
        default: 'docs'
        type: choice
        options:
          - docs
          - refactor
          - style
          - perf
          - chore
          - fix
          - feat
      target_file:
        description: 'Ð¤Ð°Ð¹Ð» Ð´Ð»Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ'
        required: true
        default: 'Main.kt'
        type: string
      custom_message:
        description: 'ÐšÐ°ÑÑ‚Ð¾Ð¼Ð½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)'
        required: false
        type: string

jobs:
  create-pr:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      
      - name: Configure Git
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
      
      - name: Display target info
        run: |
          echo "ðŸŽ¯ Ð¦ÐµÐ»ÐµÐ²Ð¾Ð¹ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹: ${{ inputs.parent_repo }}"
          echo "ðŸ“ Ð¢Ð¸Ð¿ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°: ${{ inputs.commit_type }}"
          echo "ðŸ“„ Ð¤Ð°Ð¹Ð»: ${{ inputs.target_file }}"
      
      - name: Create new branch
        id: branch
        run: |
          TIMESTAMP=$(date +%s)
          BRANCH_NAME="auto/${{ inputs.commit_type }}-${TIMESTAMP}"
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          git checkout -b ${BRANCH_NAME}
          echo "âœ… Ð¡Ð¾Ð·Ð´Ð°Ð½Ð° Ð²ÐµÑ‚ÐºÐ°: ${BRANCH_NAME}"
      
      - name: Check if file exists and create if needed
        run: |
          TARGET_FILE="${{ inputs.target_file }}"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð°
          if [ ! -f "$TARGET_FILE" ]; then
            echo "âš ï¸ Ð¤Ð°Ð¹Ð» $TARGET_FILE Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚, ÑÐ¾Ð·Ð´Ð°ÐµÐ¼..."
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾
            mkdir -p "$(dirname "$TARGET_FILE")"
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» Ñ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ð¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ñ‹Ð¼
            echo "// Auto-generated file" > "$TARGET_FILE"
            echo "âœ… Ð¤Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½: $TARGET_FILE"
          else
            echo "âœ… Ð¤Ð°Ð¹Ð» ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚: $TARGET_FILE"
          fi
      
      - name: Generate changes
        run: |
          TARGET_FILE="${{ inputs.target_file }}"
          COMMIT_MSG="${{ inputs.custom_message }}"
          
          # Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ID Ð´Ð»Ñ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹
          UNIQUE_ID=$(date +%s%N | md5sum | head -c 8)
          
          # Ð•ÑÐ»Ð¸ Ð½ÐµÑ‚ ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ, Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ
          if [ -z "$COMMIT_MSG" ]; then
            case "${{ inputs.commit_type }}" in
              "docs")
                COMMIT_MSG="Update documentation"
                ;;
              "refactor")
                COMMIT_MSG="Refactor code structure"
                ;;
              "style")
                COMMIT_MSG="Improve code formatting"
                ;;
              "perf")
                COMMIT_MSG="Performance improvements"
                ;;
              "chore")
                COMMIT_MSG="Update build configuration"
                ;;
              "fix")
                COMMIT_MSG="Bug fixes"
                ;;
              "feat")
                COMMIT_MSG="Add new features"
                ;;
            esac
          fi
          
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² Ñ„Ð°Ð¹Ð» Ñ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¼ ID
          echo "" >> "$TARGET_FILE"
          echo "// ${{ inputs.commit_type }}: ${COMMIT_MSG} [${UNIQUE_ID}]" >> "$TARGET_FILE"
          echo "// Updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> "$TARGET_FILE"
          
          echo "COMMIT_MSG=${COMMIT_MSG}" >> $GITHUB_ENV
          echo "âœ… Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð²Ð½ÐµÑÐµÐ½Ñ‹ Ð² Ñ„Ð°Ð¹Ð»: $TARGET_FILE"
      
      - name: Verify changes exist
        run: |
          if git diff --quiet; then
            echo "âŒ ÐÐµÑ‚ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð¿Ð¾ÑÐ»Ðµ Ð¼Ð¾Ð´Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Ñ„Ð°Ð¹Ð»Ð°"
            exit 1
          else
            echo "âœ… Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ñ‹"
            git diff --stat
          fi
      
      - name: Commit changes
        run: |
          git add .
          git commit -m "${{ inputs.commit_type }}: ${COMMIT_MSG}"
          echo "âœ… ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚ ÑÐ¾Ð·Ð´Ð°Ð½"
      
      - name: Push to fork
        run: |
          git push origin ${{ steps.branch.outputs.branch_name }}
          echo "âœ… Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ñ‹ Ð² Ñ„Ð¾Ñ€Ðº"
      
      - name: Create Pull Request to parent
        id: create_pr
        run: |
          PR_URL=$(gh pr create \
            --repo ${{ inputs.parent_repo }} \
            --base main \
            --head ${{ github.repository_owner }}:${{ steps.branch.outputs.branch_name }} \
            --title "${{ inputs.commit_type }}: ${COMMIT_MSG}" \
            --body "## Ð¢Ð¸Ð¿ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
          - [x] ${{ inputs.commit_type }}
          
          ## ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ
          ${COMMIT_MSG}
          
          ## Ð”ÐµÑ‚Ð°Ð»Ð¸
          - Ð¤Ð°Ð¹Ð»: ${{ inputs.target_file }}
          - ÐÐ²Ñ‚Ð¾Ñ€: @${{ github.actor }}
          - Ð”Ð°Ñ‚Ð°: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - Ð¤Ð¾Ñ€Ðº: ${{ github.repository }}
          
          ---
          *Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¾ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ñ‡ÐµÑ€ÐµÐ· GitHub Actions*")
          
          echo "pr_url=${PR_URL}" >> $GITHUB_OUTPUT
          echo "âœ… Pull Request ÑÐ¾Ð·Ð´Ð°Ð½: ${PR_URL}"
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
      
      - name: Success Summary
        run: |
          echo "# âœ… Pull Request ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Ð”ÐµÑ‚Ð°Ð»Ð¸" >> $GITHUB_STEP_SUMMARY
          echo "- **PR URL:** ${{ steps.create_pr.outputs.pr_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Ð¢Ð¸Ð¿:** ${{ inputs.commit_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ:** ${COMMIT_MSG}" >> $GITHUB_STEP_SUMMARY
          echo "- **Ð¦ÐµÐ»ÐµÐ²Ð¾Ð¹ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹:** ${{ inputs.parent_repo }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Ð’ÐµÑ‚ÐºÐ°:** ${{ steps.branch.outputs.branch_name }}" >> $GITHUB_STEP_SUMMARY
